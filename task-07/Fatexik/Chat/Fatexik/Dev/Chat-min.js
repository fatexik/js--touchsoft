var userConfig,Module;function setConfig(e){Module(userConfig=e)}Module=function(e){var t,n,o,s,a,r,i={title:"Chat",name:"Bot",url:"https://touchsoft-fatexik.firebaseio.com/",CSS:"https://rawgit.com/fatexik/js--touchsoft/master/task-03/Fatexik/Chat/Fatexik/CSS/styles.css",positionLeft:!1,allowMinimize:!0,drag:!0,requireName:!0,showTime:!0,network:"XHR",userName:"",collapsed:!1,updates:"longPooling"},c=200,u=localStorage.getItem("userId"),d=6e4,m=5e3;function l(e,t,n,o){return fetch(i.url.concat("users/").concat(u).concat(t).concat(n).concat(".json"),{method:e,headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(o)})}function g(e,t,n,o){var s=new XMLHttpRequest;return s.open(e,i.url.concat("users/").concat(u).concat(t).concat(n).concat(".json")),s.setRequestHeader("Content-Type","application/json"),s.send(JSON.stringify(o)),s}function p(){}function f(){}function h(){var e=document.createElement("div");return e.id="collapsedFeedback",e.className="collapsedFeedback",e.innerHTML='<div class="dragDropCollapsed" id="dragdrop"></div><p class="chatName" id="chatName"></p><form><input type="text" id="messageArea"> <input type="button" id="sendMessageButton" value="Send Message"> <input type="button" value="<<" id="maximize"> <span class="nameNote"><p>User Name</p></span> <input type="text" id="userName"></form>',e}function y(e){var t=e;return t<10&&(t="0".concat(e)),t}function v(){var e=document.createElement("container");return e.id="feedBack",e.className="feedBack",e.innerHTML='<div class="dragDrop" id="dragdrop"></div><p class="chatName" id="chatName">Chat</p><form><input type="button" value=">>" class="collapse" id="collapse"><p><textarea id="messageHistory" rows="8" cols="30" name="text" disabled="disabled"></textarea></p><textarea id="userName" rows="1" cols="10" name="text"></textarea><span class="nameNote">User Name</span><p></p><textarea id="messageArea" rows="3" cols="30" name="text"></textarea><br><input type="button" id="sendMessageButton" value="Send Message"></form>',e}function E(){var e=document.getElementById("messageHistory");e&&t.getMessages().then(function(t){e.value=t.join(" ")})}function C(){var e=new Date,t=document.getElementById("messageArea"),n=y(e.getMinutes()),o=y(e.getHours());return i.showTime?"\n".concat([o,n].join(":").concat(" ".concat(i.userName).concat(" ").concat(t.value))):"\n".concat(" ".concat(i.userName).concat(" ").concat(t.value))}function N(){var e,n,o=document.getElementById("messageArea");t.setConfig("userName",i.userName),"longPooling"!==i.updates?new Promise(function(e){e(t.getMessages())}).then(function(s){e=s,n=C(),e.push(n),document.getElementById("messageHistory")&&(document.getElementById("messageHistory").value=e.join(" ")),t.sendMessage(n).setTimeActivity().setUnreadMessage(),o.value=""}):(n=C(),t.sendMessage(n).setTimeActivity().setUnreadMessage(),o.value="")}function I(e){var t=document.getElementById("dragdrop");t.onmouseenter=function(){t.style.cursor="move"},t.addEventListener("mousedown",function(t){var n,o={top:(n=e.getBoundingClientRect()).top+window.pageYOffset,left:n.left+window.pageXOffset},s=t.pageX-o.left,a=t.pageY-o.top;function r(t){var n;n=t,e.style.left=n.clientX-s+"px",e.style.top=n.clientY-a+"px"}document.addEventListener("mousemove",r),e.addEventListener("mouseup",function t(){document.removeEventListener("mousemove",r),e.removeEventListener("mouseup",t)})})}function T(){var e=document.getElementById("sendMessageButton"),t=document.getElementById("userName");e.disabled=!1,i.requireName?(t.value||(e.disabled=!0),t.onkeyup=function(){t.value?(e.disabled=!1,i.userName=t.value):(e.disabled=!0,i.userName=null)}):(t.value=i.userName,t.onkeyup=function(){i.userName=t.value||"You"})}function w(){document.getElementById("collapse").disabled=!0}function B(e){e.style.left="5vw"}function b(e,n){var o,a,r,i;"Get Ip"===e.message.match(/\$\$(.+)\$\$/)[1]?(r=new XMLHttpRequest,i=/"ip": "(.+)"/,r.open("GET","http://ipinfo.io/?callback=callback"),r.setRequestHeader("Content-Type","application/json"),r.send(),new Promise(function(e){r.onreadystatechange=function(){200===this.status&&4===this.readyState&&e(this.response.match(i)[1])}})).then(function(o){e.status=o,t.sendResponseCommand(n,e)}):(o=e.message.match(/\?(.+)\?/),a=o[1],(document.getElementById("feedBack")?document.getElementById("feedBack"):document.getElementById("collapsedFeedback")).style.backgroundColor=a,s=a,e.status="Color set",t.sendResponseCommand(n,e))}function M(){t.getCommands().then(function(e){e&&Object.keys(e).forEach(function(t){"sent"===e[t].status&&b(e[t],t)})})}function S(){var e,n,s,a=!0;o&&o.abort(),(o=t.getLongPooling("commands")).onreadystatechange=function(){this.status===c&&(e=this.responseText.replace(n,""),n=this.responseText,s=JSON.parse(e.match(/\{.+\}/)),a=function(e,t){var n,o;return!e||(n=e.data,t?Object.keys(n).forEach(function(e){"sent"===n[e].status&&b(n[e],e)}):(o=e.path.split("/")[1],b(n,o)),!1)}(s,a))}}function k(){var e,o,s,a,r=!0;n&&n.abort(),(n=t.getLongPooling("messages")).onreadystatechange=function(){(e=document.getElementById("messageHistory"))&&this.status===c&&(o=this.responseText.replace(s,""),s=this.responseText,a=JSON.parse(o.match(/\{.+\}/)),r=function(e,t,n){var o;return!e||(o=Object.keys(e.data).map(function(t){return e.data[t]}),n.value=t?o.join(""):n.value.concat(o.join("")),!1)}(a,r,e))}}function j(){var e;e=document.getElementById("messageHistory"),"longPooling"!==i.updates?t.getMessages().then(function(t){e.value=t.join(" ")}):(k(),S())}function x(){var e=document.body,n=v(),o=document.getElementById("collapsedFeedback");e.replaceChild(n,o),n.style.backgroundColor=s,i.drag&&I(n),i.allowMinimize||w(),i.positionLeft&&B(n),document.getElementById("userName").value=i.userName,T(),document.getElementById("chatName").innerText=i.title,t.setConfig("collapsed",!1),j(),document.getElementById("collapse").addEventListener("click",L),document.getElementById("sendMessageButton").addEventListener("click",N)}function L(){var e=document.body,n=document.getElementById("feedBack"),o=h();e.replaceChild(o,n),o.style.backgroundColor=s,document.getElementById("userName").value=i.userName,document.getElementById("chatName").innerText=i.title,i.drag&&I(o),i.positionLeft&&B(o),T(),t.setConfig("collapsed",!0),document.getElementById("sendMessageButton").addEventListener("click",N),document.getElementById("maximize").addEventListener("click",x)}function P(){var e,t=document.body,n=v();t.appendChild(n),e=document.getElementById("userName"),i.drag&&I(n),i.allowMinimize||w(),i.positionLeft&&B(n),e.value=i.userName,T(),document.getElementById("chatName").innerText=i.title,document.getElementById("collapse").addEventListener("click",L),document.getElementById("sendMessageButton").addEventListener("click",N),j()}function O(){var e,t=document.body,n=h();t.appendChild(n),e=document.getElementById("userName"),document.getElementById("chatName").innerText=i.title,i.drag&&I(n),i.positionLeft&&B(n),e.value=i.userName,T(),document.getElementById("sendMessageButton").addEventListener("click",N),document.getElementById("maximize").addEventListener("click",x)}function U(){t="XHR"===i.network?new p:new f,localStorage.getItem("userId")?t.getUserConfig().then(function(e){i=e,t.getConfig("collapsed").then(function(e){!1===e?P():O()})}):t.createNewUser().then(function(){u=localStorage.getItem("userId"),t.getConfig("collapsed").then(function(e){!1===e?P():O()})}),"longPooling"===i.updates?(setInterval(k,d),setInterval(S,d)):(setInterval(E,1e4),setInterval(M,m))}return p.prototype.getMessages=function(){var e,t;return new Promise(function(n){g("GET","/messages","").onreadystatechange=function(){this.status===c&&4===this.readyState&&(e=JSON.parse(this.response),t=[],e&&(t=Object.keys(e).map(function(t){return e[t]})),n(t))}})},p.prototype.setUnreadMessage=function(){return g("PUT","/unreadMessage","",!0).onreadystatechange=function(){if(this.status!==c&&4===this.readyState)throw Error("Unread message not set")},this},p.prototype.sendMessage=function(e){return g("POST","/messages","",e).onreadystatechange=function(){if(this.status!==c&&4===this.readyState)throw new Error("Message not send")},this},p.prototype.sendResponseCommand=function(e,t){return g("PUT","/commands/",e,t).onreadystatechange=function(){if(this.status!==c&&4===this.readyState)throw new Error("Message not send")},this},p.prototype.setTimeActivity=function(){return g("PUT","/activityTime","",(new Date).getTime()).onreadystatechange=function(){if(this.status!==c&&4===this.readyState)throw new Error("Time activity not set")},this},p.prototype.getCommands=function(){var e;return new Promise(function(t){g("GET","/commands","").onreadystatechange=function(){this.status===c&&4===this.readyState&&(e=JSON.parse(this.response),t(e))}})},p.prototype.getUserConfig=function(){return new Promise(function(e){var t;g("GET","/chatConfig","").onreadystatechange=function(){this.status===c&&4===this.readyState&&(t=JSON.parse(this.response),i=t,e(t))}})},p.prototype.createNewUser=function(){return new Promise(function(e){var t,n=new XMLHttpRequest;n.open("POST",i.url.concat("users.json")),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify({chatConfig:i,messages:"",commands:""})),n.onreadystatechange=function(){this.status===c&&4===this.readyState&&(t=JSON.parse(this.response),localStorage.setItem("userId",t.name),e(t))}})},p.prototype.getLongPooling=function(e){var t=new XMLHttpRequest;return t.open("GET",i.url.concat("users/").concat(u).concat("/".concat(e).concat(".json"))),t.setRequestHeader("Accept","text/event-stream"),t.send(),t},p.prototype.getConfig=function(e){return new Promise(function(t){g("GET","/chatConfig/",e).onreadystatechange=function(){this.status===c&&4===this.readyState&&t(JSON.parse(this.response))}})},p.prototype.setConfig=function(e,t){return new Promise(function(n){g("PUT","/chatConfig/",e,t).onreadystatechange=function(){200===this.status&&4===this.readyState&&n(!0)}})},f.prototype.getMessages=function(){return l("GET","/messages","").then(function(e){return e.json().then(function(e){var t=[];return e&&(t=Object.keys(e).map(function(t){return e[t]})),t})})},f.prototype.getCommands=function(){return l("GET","/commands","").then(function(e){return e.json().then()})},f.prototype.sendMessage=function(e){return l("POST","/messages","",e).then(function(e){e.json()}),this},f.prototype.setTimeActivity=function(){return l("PUT","/activityTime","",(new Date).getTime()).then(function(e){e.json()}),this},f.prototype.setUnreadMessage=function(){return l("PUT","/unreadMessage","",!0).then(function(e){e.json()}),this},f.prototype.createNewUser=function(){return fetch(i.url.concat("users.json"),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({chatConfig:i,messages:"",commands:""})}).then(function(e){return e.json().then(function(e){return localStorage.setItem("userId",e.name),e})})},f.prototype.getUserConfig=function(){return l("GET","/chatConfig","").then(function(e){return e.json().then(function(e){return i=e,e})})},f.prototype.getConfig=function(e){return l("GET","/chatConfig/",e).then(function(e){return e.json().then(function(e){return e})})},f.prototype.setConfig=function(e,t){return l("PUT","/chatConfig/",e,t).then(function(e){return e.json().then(function(){return!0})})},a=document.head,(r=document.createElement("link")).setAttribute("rel","stylesheet"),r.setAttribute("href",i.CSS),r.setAttribute("type","text/css"),r.setAttribute("media","screen"),a.appendChild(r),window.onload=function(){e&&(i=e),U()},{timeCheck:y}};